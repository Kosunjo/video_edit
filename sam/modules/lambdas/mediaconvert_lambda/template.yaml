# 이 AWS SAM 템플릿은 함수의 구성에서 생성되었습니다. 함수에 트리거가 하나 이상 있는 경우 이러한 트리거와 관련된 AWS 리소스가 이
# 템플릿에 완전히 지정되어 있지 않으며 자리 표시자 값도 포함된다는 점에 유의하십시오. AWS Infrastructure Composer 또는
# 선호하는 IDE에서 이 템플릿을 열고 다른 AWS 리소스와 함께 서버리스 애플리케이션을 지정하도록 수정하십시오.
AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: An AWS Serverless Application Model template describing your function.

Parameters:
  InputBucketName:
    Type: String
  OutputBucketName:
    Type: String
  MediaConvertName:
    Type: String

Resources:
  videoconversionlambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Ref MediaConvertName
      CodeUri: .
      Description: ''
      MemorySize: 128
      Timeout: 300
      Handler: fixed_lambda_function.lambda_handler
      Runtime: python3.9
      Architectures:
        - x86_64
      EphemeralStorage:
        Size: 512
      Environment:
        Variables:
          MEDIACONVERT_ROLE_ARN: !Sub arn:aws:iam::${AWS::AccountId}:role/MediaConvertServiceRole
      EventInvokeConfig:
        MaximumEventAgeInSeconds: 21600
        MaximumRetryAttempts: 2
      PackageType: Zip
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - iam:PassRole
              Resource: '*'
            - Sid: VisualEditor0
              Effect: Allow
              Action:
                - mediaconvert:*
              Resource: '*'
            - Sid: ThumbsRW
              Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
                - s3:DeleteObject
              Resource: !Sub arn:aws:s3:::${InputBucketName}/original/thumbnails/*
            - Sid: OptionalList
              Effect: Allow
              Action:
                - s3:ListBucket
              Resource: !Sub arn:aws:s3:::${InputBucketName}
              Condition:
                StringLike:
                  s3:prefix:
                    - original/thumbnails/*
            - Sid: ListThumbsOnly
              Effect: Allow
              Action:
                - s3:ListBucket
              Resource: !Sub arn:aws:s3:::${InputBucketName}
              Condition:
                StringLike:
                  s3:prefix:
                    - thumbnails/*
            - Sid: ThumbsReadWriteDelete
              Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
                - s3:DeleteObject
              Resource: !Sub arn:aws:s3:::${InputBucketName}/thumbnails/*
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: arn:aws:logs:*:*:*
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
              Resource:
                - !Sub arn:aws:s3:::${InputBucketName}/*
                - !Sub arn:aws:s3:::${OutputBucketName}/*
            - Effect: Allow
              Action:
                - mediaconvert:CreateJob
                - mediaconvert:GetJob
                - mediaconvert:DescribeEndpoints
              Resource: '*'
            - Effect: Allow
              Action:
                - iam:PassRole
              Resource: !Sub arn:aws:iam::${AWS::AccountId}:role/MediaConvertServiceRole
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: '*'
      RecursiveLoop: Terminate
      SnapStart:
        ApplyOn: None
      Events:
        EventBridgeRule1:
          Type: EventBridgeRule
          Properties:
            Pattern:
              source:
                - aws.s3
              detail-type:
                - Object Created
              detail:
                bucket:
                  name:
                    - !Ref InputBucketName
                object:
                  key:
                    - prefix: original/
      RuntimeManagementConfig:
        UpdateRuntimeOn: Auto
