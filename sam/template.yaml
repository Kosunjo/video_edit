AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Root SAM Stack for Video Pipeline

Parameters:
  StepFunctionName:
    Type: String
    Description: "Step Function workflow name"
  InputBucketName:
    Type: String
    Description: "S3 버킷 이름" 
  OutputBucketName:
    Type: String
    Description: "S3 출력 버킷 이름"
  EventBridgeName:
    Type: String
    Description: "EventBridge Rule 이름"
  s3_input_path:
    Type: String
    Description: "S3 입력 경로"
  transcribeName:
    Type: String
    Description: "Transcribe Lambda 함수 이름"
  mediaconvertName:
    Type: String
    Description: "MediaConvert Lambda 함수 이름"

Resources:
  S3EventBridgeModule:
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/eventbridge/template.yaml
    Parameters:
      StepFunctionName: !Ref StepFunctionName
      InputBucketName: !Ref InputBucketName
      EventBridgeName: !Ref EventBridgeName
      s3_input_path: !Ref s3_input_path

  SQSModule:
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/sqs/template.yaml

  TranscribeLambdaModule:
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/lambdas/transcribe_lambda/template.yaml
    Parameters:
      InputBucketName: !Ref InputBucketName
      OutputBucketName: !Ref OutputBucketName
      transcribeName: !Ref transcribeName

  MediaConvertLambdaModule:
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/lambdas/mediaconvert_lambda/template.yaml
    Parameters:
      InputBucketName: !Ref InputBucketName
      OutputBucketName: !Ref OutputBucketName
      mediaConvertName: !Ref mediaConvertName

  StepFunctionsModule:
    Type: AWS::Serverless::Application
    Properties:
      Location: ./modules/stepfunctions/template.yaml
    Parameters:
      transcribeName: !Ref transcribeName
      mediaConvertName: !Ref mediaConvertName
